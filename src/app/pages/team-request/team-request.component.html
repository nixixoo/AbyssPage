<div class="team-request-container">
  <div class="overlay"></div>
  <app-header></app-header>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading" @fadeOut>
    <div class="loading-spinner">
      <img src="assets/logo.png" alt="Loading..." class="spinning-logo">
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="loadingProgress"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <ng-container *ngIf="!isLoading && targetUser">
    <!-- Page Titles -->
    <div class="page-titles">
      <h1>Team Request</h1>
      <h2 *ngIf="targetUser">Request a team to {{ targetUser.username }}</h2>
    </div>

    <!-- Sidebar -->
    <div class="filter-sidebar" [class.open]="isSidebarOpen">
      <button class="toggle-btn" (click)="toggleSidebar()">
        <span class="vertical-text">FILTERS</span>
        <i class="fas" [class.fa-chevron-right]="!isSidebarOpen" [class.fa-chevron-left]="isSidebarOpen"></i>
      </button>

      <div class="sidebar-content">
        <div class="filter-section">
          <!-- Elements -->
          <div class="filter-group">
            <div class="filter-title">Element</div>
            <div class="filter-options">
              <div class="filter-option" 
                   *ngFor="let element of elements"
                   [attr.data-element]="element"
                   [class.active]="isElementSelected(element)"
                   (click)="filterByElement(element)">
                <img [src]="'assets/others/' + element.toLowerCase() + '.webp'" [alt]="element">
                <span>{{ element }}</span>
                
                <ng-container [ngSwitch]="element">
                  <ng-container *ngSwitchCase="'Pyro'">
                    <div class="particle" *ngFor="let i of [].constructor(20)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Hydro'">
                    <div class="particle" *ngFor="let i of [].constructor(20)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Anemo'">
                    <div class="particle" *ngFor="let i of [].constructor(40)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Electro'">
                    <div class="particle" *ngFor="let i of [].constructor(100)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Dendro'">
                    <div class="particle" *ngFor="let i of [].constructor(100)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Cryo'">
                    <div class="particle" *ngFor="let i of [].constructor(50)"></div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'Geo'">
                    <div class="particle-1"></div>
                    <div class="shard-left-1"></div>
                    <div class="shard-right-1"></div>
                    <div class="particle-2"></div>
                    <div class="shard-left-2"></div>
                    <div class="shard-right-2"></div>
                    <div class="particle-3"></div>
                    <div class="shard-left-3"></div>
                    <div class="shard-right-3"></div>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Weapons -->
          <div class="filter-group">
            <div class="filter-title">Weapon</div>
            <div class="filter-options">
              <div class="filter-option" 
                   *ngFor="let weapon of weapons"
                   [attr.data-weapon]="weapon"
                   [class.active]="isWeaponSelected(weapon)"
                   (click)="filterByWeapon(weapon)">
                <img [src]="'assets/others/' + weapon.toLowerCase() + '.webp'" [alt]="weapon">
                <span>{{ weapon }}</span>
                
                <!-- Sword -->
                <ng-container *ngIf="weapon === 'Sword'">
                  <div class="slash"></div>
                  <div class="slash"></div>
                </ng-container>

                <!-- Claymore -->
                <ng-container *ngIf="weapon === 'Claymore'">
                  <div class="heavy-slash"></div>
                </ng-container>

                <!-- Polearm -->
                <ng-container *ngIf="weapon === 'Polearm'">
                  <div class="quick-slash"></div>
                  <div class="quick-slash"></div>
                  <div class="quick-slash"></div>
                </ng-container>

                <!-- Bow -->
                <ng-container *ngIf="weapon === 'Bow'">
                  <div class="arrow"></div>
                </ng-container>

                <!-- Catalyst -->
                <ng-container *ngIf="weapon === 'Catalyst'">
                  <div class="magic-orb"></div>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Rarity -->
          <div class="filter-group">
            <div class="filter-title">Rarity</div>
            <div class="filter-options">
              <div class="filter-option" 
                   (click)="filterByRarity(4)" 
                   [attr.data-rarity]="4" 
                   [class.active]="isRaritySelected(4)">
                <div class="rarity-stars four-star">★★★★</div>
              </div>
              <div class="filter-option" 
                   (click)="filterByRarity(5)" 
                   [attr.data-rarity]="5" 
                   [class.active]="isRaritySelected(5)">
                <div class="rarity-stars five-star">★★★★★</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <div class="content-wrapper" [class.sidebar-open]="isSidebarOpen">
        <div class="team-request-form">
          <div class="two-column-layout">
            <!-- Left Column - Characters -->
            <div class="left-column">
              <div class="character-selection">
                <div class="characters-grid">
                  <div class="character-card" 
                       *ngFor="let character of availableCharacters"
                       [class.selected]="selectedCharacters.includes(character.id)"
                       [attr.data-character-id]="character.id"
                       (click)="selectCharacter(character.id)">
                    <div class="constellation-level">
                      C{{ getConstellationLevel(character.id) }}
                    </div>
                    <div class="character-image" [attr.data-rarity]="character.rarity">
                      <img [src]="character.image" [alt]="character.name">
                      <div class="rarity">
                        <span *ngFor="let star of [].constructor(character.rarity)">★</span>
                      </div>
                    </div>
                    <div class="character-info">
                      <h3>{{ character.name }}</h3>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Message & Submit -->
            <div class="right-column">
              <div class="selected-count">
                {{ selectedCharacters.length }}/4 Characters Selected
              </div>

              <div class="selected-preview">
                <div class="preview-slots">
                  <div class="preview-slot" *ngFor="let i of [0,1,2,3]">
                    <div class="preview-card" 
                         *ngIf="selectedCharacters[i]" 
                         (click)="removeCharacter(i)"
                         [@cardAnimation]>
                      <div class="preview-image">
                        <img [src]="getCharacterById(selectedCharacters[i])?.image || ''" 
                             [alt]="getCharacterById(selectedCharacters[i])?.name || ''"
                             (error)="handleImageError($event)">
                      </div>
                      <div class="preview-name">
                        {{ getCharacterById(selectedCharacters[i])?.name || 'Unknown Character' }}
                      </div>
                    </div>
                    <div class="empty-slot" *ngIf="!selectedCharacters[i]">
                      <i class="fas fa-plus"></i>
                    </div>
                  </div>
                </div>
              </div>

              <div class="name-input">
                <input 
                  [(ngModel)]="displayName" 
                  placeholder="Your username (optional)"
                  type="text"
                  maxlength="30">
              </div>

              <div class="message-input">
                <textarea 
                  [(ngModel)]="message" 
                  placeholder="Add a message to your request (optional)"
                  rows="4">
                </textarea>
              </div>
              <button 
                class="submit-btn" 
                [disabled]="selectedCharacters.length !== 4 || isSubmitting || requestSent"
                (click)="submitRequest()">
                <span *ngIf="selectedCharacters.length === 4">
                  <ng-container *ngIf="!requestSent; else sentMessage">
                    Send Team Request
                    <div class="loading-spinner" *ngIf="isSubmitting">
                      <div class="spinner"></div>
                    </div>
                  </ng-container>
                  <ng-template #sentMessage>
                    Request Sent
                  </ng-template>
                </span>
                <span *ngIf="selectedCharacters.length !== 4">
                  Select {{ 4 - selectedCharacters.length }} more character{{ 4 - selectedCharacters.length === 1 ? '' : 's' }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </ng-container>

  <!-- States -->
  <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
  <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
</div> 