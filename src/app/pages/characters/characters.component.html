<div class="characters-container">
  <div class="overlay"></div>

  <app-header></app-header>

  <!-- Show loading state -->
  <div class="loading-state" *ngIf="isLoading" @fadeOut>
    <div class="loading-spinner">
      <img src="assets/logo.png" alt="Loading..." class="spinning-logo">
    </div>
  </div>

  <!-- Show login message if not authenticated -->
  <div class="login-message" *ngIf="authChecked && !isAuthenticated">
    <h2>Authentication Required</h2>
    <p>Please log in to view and manage your characters.</p>
    <button class="login-btn" (click)="navigateToLogin()">
      Go to Login
    </button>
  </div>

  <!-- Show main content if authenticated -->
  <ng-container *ngIf="authChecked && isAuthenticated">
    <!-- Move titles outside main into page-titles -->
    <div class="page-titles">
      <h1>Your Characters</h1>
      <h2>Select the characters you own</h2>
    </div>

    <!-- Sidebar -->
    <div class="filter-sidebar" [class.open]="isSidebarOpen">
      <button class="toggle-btn" (click)="toggleSidebar()">
        <span class="vertical-text">FILTERS</span>
        <i class="fas" [class.fa-chevron-right]="!isSidebarOpen" [class.fa-chevron-left]="isSidebarOpen"></i>
      </button>

      <div class="sidebar-content">
        <div class="filter-section">
          <!-- Elements -->
          <div class="filter-group">
            <div class="filter-title">Element</div>
            <div class="filter-options">

              <div class="filter-option" 
                   [attr.data-element]="'Pyro'"
                   [class.active]="isElementSelected('Pyro')"
                   (click)="filterByElement('Pyro')">
                <img src="assets/others/pyro.webp" alt="Pyro">
                <span>Pyro</span>
                <div class="particle" *ngFor="let i of [].constructor(20)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Hydro'"
                   [class.active]="isElementSelected('Hydro')"
                   (click)="filterByElement('Hydro')">
                <img src="assets/others/hydro.webp" alt="Hydro">
                <span>Hydro</span>
                <div class="particle" *ngFor="let i of [].constructor(20)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Anemo'"
                   [class.active]="isElementSelected('Anemo')"
                   (click)="filterByElement('Anemo')">
                <img src="assets/others/anemo.webp" alt="Anemo">
                <span>Anemo</span>
                <div class="particle" *ngFor="let i of [].constructor(40)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Electro'"
                   [class.active]="isElementSelected('Electro')"
                   (click)="filterByElement('Electro')">
                <img src="assets/others/electro.webp" alt="Electro">
                <span>Electro</span>
                <div class="particle" *ngFor="let i of [].constructor(100)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Dendro'"
                   [class.active]="isElementSelected('Dendro')"
                   (click)="filterByElement('Dendro')">
                <img src="assets/others/dendro.webp" alt="Dendro">
                <span>Dendro</span>
                <div class="particle" *ngFor="let i of [].constructor(100)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Cryo'"
                   [class.active]="isElementSelected('Cryo')"
                   (click)="filterByElement('Cryo')">
                <img src="assets/others/cryo.webp" alt="Cryo">
                <span>Cryo</span>
                <div class="particle" *ngFor="let i of [].constructor(50)"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-element]="'Geo'"
                   [class.active]="isElementSelected('Geo')"
                   (click)="filterByElement('Geo')">
                <img src="assets/others/geo.webp" alt="Geo">
                <span>Geo</span>
                <div class="particle-1"></div>
                <div class="shard-left-1"></div>
                <div class="shard-right-1"></div>
                <div class="particle-2"></div>
                <div class="shard-left-2"></div>
                <div class="shard-right-2"></div>
                <div class="particle-3"></div>
                <div class="shard-left-3"></div>
                <div class="shard-right-3"></div>
              </div>
            </div>
          </div>

          <!-- Weapons -->
          <div class="filter-group">
            <div class="filter-title">Weapon</div>
            <div class="filter-options">
              <div class="filter-option" 
                   [attr.data-weapon]="'Sword'"
                   [class.active]="isWeaponSelected('Sword')"
                   (click)="filterByWeapon('Sword')">
                <img src="assets/others/sword.webp" alt="Sword">
                <span>Sword</span>
                <div class="slash"></div>
                <div class="slash"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-weapon]="'Claymore'"
                   [class.active]="isWeaponSelected('Claymore')"
                   (click)="filterByWeapon('Claymore')">
                <img src="assets/others/claymore.webp" alt="Claymore">
                <span>Claymore</span>
                <div class="heavy-slash"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-weapon]="'Polearm'"
                   [class.active]="isWeaponSelected('Polearm')"
                   (click)="filterByWeapon('Polearm')">
                <img src="assets/others/polearm.webp" alt="Polearm">
                <span>Polearm</span>
                <div class="quick-slash"></div>
                <div class="quick-slash"></div>
                <div class="quick-slash"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-weapon]="'Bow'"
                   [class.active]="isWeaponSelected('Bow')"
                   (click)="filterByWeapon('Bow')">
                <img src="assets/others/bow.webp" alt="Bow">
                <span>Bow</span>
                <div class="arrow"></div>
              </div>
              <div class="filter-option" 
                   [attr.data-weapon]="'Catalyst'"
                   [class.active]="isWeaponSelected('Catalyst')"
                   (click)="filterByWeapon('Catalyst')">
                <img src="assets/others/catalyst.webp" alt="Catalyst">
                <span>Catalyst</span>
                <div class="magic-orb"></div>
              </div>
            </div>
          </div>

          <!-- Rarity -->
          <div class="filter-group">
            <div class="filter-title">Rarity</div>
            <div class="filter-options">
              <div class="filter-option" (click)="filterByRarity(4)" [attr.data-rarity]="4" [class.active]="isRaritySelected(4)">
                <div class="rarity-stars four-star">★★★★</div> 
              </div>
              <div class="filter-option" (click)="filterByRarity(5)" [attr.data-rarity]="5" [class.active]="isRaritySelected(5)">
                <div class="rarity-stars five-star">★★★★★</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <div class="content-wrapper" [class.sidebar-open]="isSidebarOpen">
        <div class="characters-section">
          <div class="characters-grid" [class.loading]="isLoading">
            <div class="character-card" 
                 *ngFor="let character of displayedCharacters"
                 [class.owned]="isCharacterOwned(character.id)"
                 [attr.data-character-id]="character.id"
                 (click)="toggleCharacter(character)">
              <div class="character-image" [attr.data-rarity]="character.rarity">
                <img [src]="character.image" [alt]="character.name">
                <div class="rarity">
                  <span *ngFor="let star of [].constructor(character.rarity)">★</span>
                </div>
              </div>
              <div class="character-info">
                <h3>{{ character.name }}</h3>
                <div class="constellation-selector">
                  <button class="cons-btn c0" (click)="setConsLevel($event, character, 0)">C0</button>
                  <button class="cons-btn minus" (click)="decreaseConsLevel($event, character)">-</button>
                  <span class="cons-level">C{{ getCharacterCons(character.id) || '0' }}</span>
                  <button class="cons-btn plus" (click)="increaseConsLevel($event, character)">+</button>
                  <button class="cons-btn c6" (click)="setConsLevel($event, character, 6)">C6</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button 
            class="save-btn" 
            [class.visible]="!isLoading && hasPendingChanges()"
            (click)="saveChanges()"
            *ngIf="true">
            {{ isLoading ? 'Saving...' : 'Apply Changes' }}
          </button>
          <button 
            class="discard-btn" 
            [class.visible]="!isLoading && hasPendingChanges()"
            (click)="discardChanges()"
            *ngIf="true">
            Discard Changes
          </button>
        </div>
      </div>

      <div class="loading" *ngIf="isLoading">
        <svg class="spinner" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
        </svg>
      </div>
    </main>
  </ng-container>
</div>
